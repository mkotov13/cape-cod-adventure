<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curated Cape Cod Escapes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (Linen, Slate, Sand) -->
    <!-- Application Structure Plan: The SPA uses a tabbed navigation structure. Initially, it shows the itinerary selection and details. A new "Live Map" tab allows users to switch to a dynamic map view. This structure provides two distinct but related exploration paths (detailed text vs. geographical overview) without page reloads. This design ensures user understanding and easy navigation between planning details and geographical context. -->
    <!-- Visualization & Content Choices: Report Info: Driving Times -> Goal: Compare -> Viz: Bar Chart -> Interaction: Hover for tooltip -> Justification: Easiest way to compare the three numerical data points. Library: Chart.js. Report Info: Three Itineraries & Locations -> Goal: Organize & Inform -> Viz: Interactive Cards & Dynamic Timeline (for itineraries) and Interactive Map (for geographical context) -> Interaction: Click card to show/hide relevant timeline, Click tab to switch view, Click map marker for info, Live location toggle -> Justification: Provides comprehensive detail and spatial understanding. The map visually groups points by itinerary via distinct marker colors and integrates user live location for real-world utility. Method: Vanilla JS & Tailwind CSS for UI and interaction, Google Maps API for map. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fdfdf5; /* A very light, warm off-white */
        }
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
        .itinerary-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .itinerary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .itinerary-card.active {
            border-color: #4a5568; /* Slate Gray */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            top: 1.25rem;
            left: -0.5rem;
            transform: translateX(-50%);
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #c7a783; /* Muted Sand */
            border: 2px solid #fdfdf5;
        }
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .details-content.show {
            max-height: 500px; /* Adjust as needed */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #map-container {
            height: 600px; /* Default height for the map */
            width: 100%;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            margin-top: 1.5rem;
        }
        /* Make the map responsive */
        @media (min-width: 768px) {
            #map-container {
                height: 700px; /* Taller on larger screens */
            }
        }
        .info-window-content h3 {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }
        .info-window-content p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 0.9em;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-2">Curated Cape Cod Escapes</h1>
            <p class="text-lg text-gray-600">A chic half-day guide for Sunday, June 29, 2025. Less crowds, more charm.</p>
        </header>

        <nav class="flex justify-center space-x-4 mb-8">
            <button class="tab-button px-6 py-2 rounded-full font-semibold text-lg transition-colors duration-200 bg-gray-200 hover:bg-gray-300 active-tab" data-tab="itineraries">Itineraries</button>
            <button class="tab-button px-6 py-2 rounded-full font-semibold text-lg transition-colors duration-200 bg-gray-200 hover:bg-gray-300" data-tab="map">Live Map</button>
        </nav>

        <main>
            <section id="itineraries-tab-content" class="tab-content active">
                <section id="itinerary-selector" class="mb-12">
                    <h2 class="text-2xl font-bold text-center mb-8">Choose Your Vibe</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        
                        <div id="wellfleet-card" data-town="wellfleet" class="itinerary-card cursor-pointer bg-white p-6 rounded-lg shadow-md border-2 border-transparent text-center">
                            <div class="text-4xl mb-3">üé®</div>
                            <h3 class="text-xl font-bold font-display mb-2">Wellfleet</h3>
                            <p class="text-gray-600 mb-4">Coastal Elegance & Artistic Finds</p>
                            <span class="text-sm font-semibold text-gray-700 bg-gray-100 py-1 px-3 rounded-full">~48 min drive</span>
                        </div>

                        <div id="orleans-card" data-town="orleans" class="itinerary-card cursor-pointer bg-white p-6 rounded-lg shadow-md border-2 border-transparent text-center">
                            <div class="text-4xl mb-3">üåø</div>
                            <h3 class="text-xl font-bold font-display mb-2">Orleans</h3>
                            <p class="text-gray-600 mb-4">Quaint Charm & Serene Views</p>
                            <span class="text-sm font-semibold text-gray-700 bg-gray-100 py-1 px-3 rounded-full">~31 min drive</span>
                        </div>

                        <div id="harwich-card" data-town="harwich" class="itinerary-card cursor-pointer bg-white p-6 rounded-lg shadow-md border-2 border-transparent text-center">
                            <div class="text-4xl mb-3">‚öì</div>
                            <h3 class="text-xl font-bold font-display mb-2">Harwich Port</h3>
                            <p class="text-gray-600 mb-4">Laid-Back Luxury & Hidden Gems</p>
                            <span class="text-sm font-semibold text-gray-700 bg-gray-100 py-1 px-3 rounded-full">~35 min drive</span>
                        </div>
                    </div>
                </section>

                <section id="itinerary-details" class="transition-opacity duration-500 ease-in-out">
                </section>

                <section class="mt-16 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-center mb-6">Drive Time at a Glance</h2>
                    <p class="text-center text-gray-600 mb-8">This chart shows the estimated one-way driving time from your starting point in Centerville to each town. Use this to help plan your travel and decide which escape best fits your schedule. Hover over the bars for exact minutes.</p>
                    <div class="chart-container">
                        <canvas id="driveTimeChart"></canvas>
                    </div>
                </section>
            </section>

            <section id="map-tab-content" class="tab-content">
                <h2 class="text-2xl font-bold text-center mb-8">Cape Cod Itinerary Map</h2>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-grow">
                        <div id="map-container"></div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg md:w-1/3">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Filter Map Points</h2>
                        <div class="flex flex-wrap gap-3 mb-6">
                            <button class="filter-map-button bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-itinerary="All">All Itineraries</button>
                            <button class="filter-map-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-itinerary="wellfleet">Wellfleet</button>
                            <button class="filter-map-button bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-itinerary="orleans">Orleans</button>
                            <button class="filter-map-button bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-itinerary="harwich">Harwich Port</button>
                        </div>

                        <button id="toggleMapLocation" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-colors duration-200 mb-6">
                            Enable Live Location
                        </button>

                        <div class="mt-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-3">Legend:</h3>
                            <ul class="space-y-2">
                                <li class="flex items-center text-gray-700"><span class="w-4 h-4 rounded-full mr-3 bg-blue-500"></span>Wellfleet</li>
                                <li class="flex items-center text-gray-700"><span class="w-4 h-4 rounded-full mr-3 bg-green-500"></span>Orleans</li>
                                <li class="flex items-center text-gray-700"><span class="w-4 h-4 rounded-full mr-3 bg-orange-500"></span>Harwich Port</li>
                                <li class="flex items-center text-gray-700"><span class="w-4 h-4 rounded-full mr-3 bg-purple-500"></span>Centerville (Start)</li>
                                <li class="flex items-center text-gray-700"><span class="w-4 h-4 rounded-full mr-3 bg-gray-500"></span>Your Location (üö≤)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 text-gray-500 text-sm">
            <p>Itineraries and business hours confirmed for Sunday, June 29, 2025. Always a good idea to double-check locally!</p>
            <p>Designed with üèôÔ∏è yuppie girlies in mind.</p>
        </footer>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        const itineraryData = {
            wellfleet: {
                title: 'Wellfleet: Coastal Elegance & Artistic Finds',
                description: "Wellfleet is a magnet for creative souls and a haven of good taste. It boasts dozens of unique shops and galleries while maintaining a quieter, more secluded feel. This itinerary balances artistic vibrancy with peaceful charm for a refined yet relaxed day.",
                timeline: [
                    { type: 'cafe', title: 'Morning Indulgence: The Flying Fish Cafe', content: 'Start with coffee and a freshly baked treat from the in-house Wildflour Bakery. A local fixture with a welcoming feel.', details: { address: '262 Main Street, Wellfleet, MA 02667', hours: '7 AM - 9 PM', link: 'https://maps.app.goo.gl/9xX6oGkX1R63wLwH8'}, lat: 41.9360, lng: -70.0306,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1504178550293-ad557993a400?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw3fHxjYWZlJTIwY291bnRlcnxlbnwwfHx8fDE3MDkwNDAwMDB8MA', alt: 'Bright and inviting cafe counter with pastries', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d3c7b2/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1561043329-847321e25e36?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxNHx8YnJlYWtmYXN0JTIwYmFkZXJ5fGVufDB8fHx8MTcwOTA0MDAwMHww', alt: 'Assortment of freshly baked goods on display', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d3c7b2/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1517978297778-9e58309a478b?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxMHx8Y29mZmVlJTIwYW5kJTIwcGFzdHJpZXN8ZW58MHx8fHwxNzA5MDQwMDAwfDA', alt: 'Coffee cup with a croissant on a cafe table', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d3c7b2/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'shop', title: 'Boutique Browsing: Main Street Gems', content: 'Explore a curated collection of contemporary clothing, handmade gifts, and unique jewelry in shops like Salt, Drift, and Sailor.', details: [
                        { name: 'Salt', link: 'https://maps.app.goo.gl/u4i5y5eF2vR2Ff84A' },
                        { name: 'Drift', link: 'https://maps.app.goo.gl/3547J81uWwD36WpW8' },
                        { name: 'Off Center', link: 'https://maps.app.goo.gl/hYm49u8p9Jc8N7oB7' },
                        { name: 'Ragg Time Ltd.', link: 'https://maps.app.goo.gl/8n9nKqJzK4P8y4eK7' },
                        { name: 'Sailor', link: 'https://maps.app.goo.gl/3y6rP4L8Y2R7U4cW9' }
                    ], lat: 41.9332, lng: -70.0336,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1549449033-038b368725ae?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwzfHxzY2VuZWklMjBtYWluJTIwc3RyZWV0JTIwc2hvcHBpbmclMjBjYXBlJTIwY29kfGVufDB8fHx8MTcwODY0MjIwM3ww', alt: 'Charming Main Street with boutique storefronts', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0c4de/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1582218497049-f8319f7e804f?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw1fHxjcmFmdCUyMGdpZnRzJTIwc2hvcHxlbnwwfHx8fDE3MDg2NDIyMDN8MA', alt: 'Interior of a craft and gift shop with unique items', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0c4de/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1594938634842-83563969a5a3?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxfHxhcnRpc2FuJTIwamV3ZWxyeXxlbnwwfHx8fDE3MDg2NDIyMDN8MA', alt: 'Display of handmade artisan jewelry', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0c4de/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'lunch', title: 'Appealing Lunch: The Flying Fish Cafe', content: 'Return for a relaxed lunch featuring a delicious selection of items prepared by a master chef in a lively, local atmosphere.', details: { address: '262 Main Street, Wellfleet, MA 02667', hours: 'Open for Lunch', link: 'https://maps.app.goo.gl/9xX6oGkX1R63wLwH8'}, lat: 41.9360, lng: -70.0306,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1555243302-d178e589887e?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxNXx8Y2FmZSUyMGZvb2QlMjBwbGF0ZXN8ZW58MHx8fHwxNzA4NjQyNTcyfDA', alt: 'Deliciously plated lunch dishes', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/a9a9a9/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1546914717-3ac66df2e6d6?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxfHxyZXN0YXVyYW50JTIwYXRtb3NwaGVyZXxlbnwwfHx8fDE3MDg2NDI1NzJ8MA', alt: 'Vibrant restaurant interior with diners', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/a9a9a9/fdfdf5?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'walk', title: 'Scenic Stroll: Uncle Tim\'s Bridge', content: 'Take a short, historic walk across this bridge spanning Duck Creek. It offers spectacular, tranquil views of the salt marsh. An easy 0.5-mile walk.', details: { address: '300 Main St, Wellfleet, MA 02667', hours: 'Public access', link: 'https://maps.app.goo.gl/193jJ3rK9ZJ2f3wS7'}, lat: 41.9333, lng: -70.0250,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1598284534720-e7178d8a7c2e?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw1fHx1bmNsZSUyMHRpbXMlMjBicmlkZ2V8ZW58MHx8fHwxNzA4NjQyNjQwfDA', alt: 'Wooden bridge over a calm waterway with salt marsh', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/8fbc8f/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1629851080350-a92c3a37d6e6?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxfHxzYWx0JTIwbWFyc2glMjBjYXBlJTIwY29kfGVufDB8fHx8MTcwODY0MjY0MHww', alt: 'Expansive salt marsh landscape with water channels', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/8fbc8f/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1601004318041-c7d0d62a937c?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwzfHxhbmdsZSUyMHZpZXclMjBvZiUyMHNhbHQlMjBtYXJzaCUyMGF0JTIwYnJpZGdlfGVufDB8fHx8MTcwODY0MjY0MHww', alt: 'Scenic view from a bridge overlooking a salt marsh', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/8fbc8f/fdfdf5?text=Image+Not+Found';" }
                      ]
                    }
                ]
            },
            orleans: {
                title: 'Orleans: Quaint Charm & Serene Views',
                description: 'Orleans offers a charming, vibrant art scene and great shopping without being as congested as other towns. This itinerary provides a lively yet manageable atmosphere for a day of rich, engaging, and relaxed exploration.',
                timeline: [
                    { type: 'cafe', title: 'Morning Brew & Bites: Hot Chocolate Sparrow', content: 'A local institution and charming caffeine haven. Enjoy specialty coffee, rich chocolates, and a cozy ambiance.', details: { address: '5 Old Colony Way, Orleans, MA 02653', hours: '6:45 AM - 7:30 PM', link: 'https://maps.app.goo.gl/2Fj9iXz6kR7yJ8T8A'}, lat: 41.7951, lng: -69.9968,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1559812975-f8a4f89d3d0f?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxNHx8Y29mZmVlJTIwYW5kJTIwYmFnZWxzfGVufDB8fHx8MTcwODY0MzExM3ww', alt: 'Coffee cup with a freshly toasted bagel', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b4d2e7/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1541416408272-911b333a4f89?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwyfHxhcnRpc2FuJTIwY2hvY29sYXRlc3xlbnwwfHx8fDE3MDg2NDI3Njl8MA', alt: 'Hand-dipped chocolates and confectionery display', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b4d2e7/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1497935586351-b67a49e012bf?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxOHx8Y296eSUyMGNhZmUlMjBpbnRlcmlvcnxlbnwwfHx8fDE3MDg2NDI3NzB8MA', alt: 'Warm and inviting cafe interior with wooden tables', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b4d2e7/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'shop', title: 'Curated Shopping: Village Center & East Orleans', content: 'Discover a mix of boutique retailers, from the beachy, modern styles at Homegrown Boutique to the upscale finds at Weekend.', details: [
                        { name: "Watson's Style", link: 'https://maps.app.goo.gl/g69S2HwR7J8T8U9V6' },
                        { name: "Homegrown Boutique", link: 'https://maps.app.goo.gl/L8c4F3J8G7H9K2L3A' },
                        { name: "Salty Crown Boutique", link: 'https://maps.app.goo.gl/Q7R2T9Y5U4W1X0Z8C' },
                        { name: "Weekend (East Orleans)", link: 'https://maps.app.goo.gl/P0Q5R23V4W1X' }
                    ], lat: 41.7944, lng: -69.9983,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1605634676664-d4218f2d5e7a?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwyfHxtb2Rlcm4lMjBjbG90aGluZyUyMGJvdXRpcXVlfGVufDB8fHx8MTcwODY0Mjg1OXww', alt: 'Stylish clothing display in a modern boutique', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d2b48c/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1588667500511-73693e507722?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw3fHxhcnQlMjBnYWxsZXJ5JTIwaW50ZXJpb3J8ZW58MHx8fHwxNzA4NjQyODU5fDA', alt: 'Art gallery interior with paintings on display', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d2b48c/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1594248432578-838c6411d331?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw4fHxoYW5kbWFkZSUyMGdpZnRzJTIwc2hvcHxlbnwwfHx8fDE3MDg2NDI4NTl8MA', alt: 'Shelves filled with unique home goods and gifts', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d2b48c/fdfdf5?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'lunch', title: 'Appealing Lunch: Navillus', content: 'An upscale dining experience with a "big city vibe." Enjoy delicious craft cocktails and creative twists on popular dishes.', details: { address: '136 Rt. 6A, Orleans, MA 02653', hours: '12 PM - 9 PM', link: 'https://maps.app.goo.gl/K6L1M8N9O2P3Q4R5S'}, lat: 41.7972, lng: -69.9959,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1579735414210-9b6f17e0b57e?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw1fHxyZXN0YXVyYW50JTIwYmFyJTIwY291bnRlcnxlbnwwfHx8fDE3MDg2NDI5NDh8MA', alt: 'Modern restaurant interior with a stylish bar area', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0e0e6/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1563222384-2544e45d94fc?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw0fHxjcmFmdCUyMGNvY2t0YWlsc3xlbnwwfHx8fDE3MDg2NDI5NDh8MA', alt: 'Assortment of colorful craft cocktails', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0e0e6/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1582210427339-b9d997232230?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw5fHxncmVhdCUyMGZvb2QlMjBwbGF0ZWR8ZW58MHx8fHwxNzA4NjQyOTQ5fDA', alt: 'Exquisitely plated gourmet dish', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/b0e0e6/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'walk', title: 'Scenic Stroll: Kent\'s Point', content: 'A peaceful walk through wooded upland, salt marsh, and a small sandy beach. The 1-1.5 mile trail offers picturesque views.', details: { address: '39 Keziah\'s Lane, Orleans, MA 02653', hours: 'Public access', link: 'https://maps.app.goo.gl/L9M4N1O8P5Q2R3S0T'}, lat: 41.7820, lng: -69.9670,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1598466100803-0c46a6f6f9e2?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwzfHxuYXR1cmUlMjB0cmFpbCUyMGZvcmVzdHxlbnwwfHx8fDE3MDg2NDMwMzJ8MA', alt: 'Wooded trail in a conservation area', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/add8e6/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1629851080350-a92c3a37d6e6?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxfHxzYWx0JTIwbWFyc2glMjBjYXBlJTIwY29kfGVufDB8fHx8MTcwODY0MzAzMnww', alt: 'Scenic view of a salt marsh and water', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/add8e6/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1510444390709-b67f1b7b7f1e?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwyMHx8c2FuZHklMjBiZWFjaCUyMGNvYXN0YWx8ZW58MHx8fHwxNzA4NjQzMDMyfDA', alt: 'Small sandy beach on a calm day', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/add8e6/2e3a47?text=Image+Not+Found';" }
                      ]
                    }
                ]
            },
            harwich: {
                title: 'Harwich Port: Laid-Back Luxury & Hidden Gems',
                description: 'With a "preppy, yet, laid back" vibe, Harwich Port has one of the nation\'s best main streets. This itinerary offers a relaxed exploration of local boutiques and charming eateries in a refined yet unpretentious atmosphere.',
                timeline: [
                    { type: 'cafe', title: 'Sweet Start: Buckies Biscotti', content: 'A beloved local bakery open for over 20 years. Famous for its biscotti, but also offers great coffee, bagels, and breakfast sandwiches.', details: { address: '681 Route 28, Dennis Port, MA 02639', hours: '7 AM - 7 PM', link: 'https://maps.app.goo.gl/Z2X7Y4W1V8U5T6S3R'}, lat: 41.6669, lng: -70.1585,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1554901597-2a20a4066266?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwyfHxiYWtlcnklMjBjb3VudGVyJTIwYmlzY290dGl8ZW58MHx8fHwxNzA5MDQwNTAwfDA', alt: 'Display counter with various baked goods', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/ffe4e1/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1559812975-f8a4f89d3d0f?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxNHx8Y29mZmVlJTIwYW5kJTIwYmFnZWxzfGVufDB8fHx8MTcwODY0MzExM3ww', alt: 'Coffee and a freshly toasted bagel', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/ffe4e1/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1555541655-b4618a0a992a?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw2fHxjYWZlJTIwZXh0ZXJpb3J8ZW58MHx8fHwxNzA4NjQyMTMxfDA', alt: 'Inviting bakery interior with display cases', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/ffe4e1/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'shop', title: 'Unique Boutiques: Harwich Port Main Street', content: 'Explore unique shops like Cape Life Gifts for souvenirs and Sativa, a gift shop with something for everyone.', details: [
                        { name: 'Cape Life Gifts', link: 'https://maps.app.goo.gl/B5C0D7E8F9G1H2I3J' },
                        { name: 'Sativa', link: 'https://maps.app.goo.gl/C6D1E8F9G2H3I4J5K' },
                        { name: 'Dune Jewelry', link: 'https://maps.app.goo.gl/D7E2F9G0H3I4J5K6L' }
                    ], lat: 41.6657, lng: -70.0767,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1549449033-038b368725ae?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwzfHxzY2VuZWklMjBtYWluJTIwc3RyZWV0JTIwc2hvcHBpbmclMjBjYXBlJTIwY29kfGVufDB8fHx8MTcwODY0MjIwM3ww', alt: 'Charming street with boutique storefronts and flowers', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/e0ffff/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1574635677989-13e00b39f1e1?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw1fHxtb2Rlcm4lMjBnaWZ0JTIwc2hvcHxlbnwwfHx8fDE3MDg2NDMyNDJ8MA', alt: 'Interior of a stylish gift shop with unique items', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/e0ffff/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1571597811910-f1c5d9a0d874?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw0fHxqZXdlbHJ5JTIwZGlzcGxheXxlbnwwfHx8fDE3MDg2NDMyNDJ8MA', alt: 'Display of elegant jewelry pieces', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/e0ffff/2e3a47?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'lunch', title: 'Gourmet Lunch: Brax Landing', content: 'A waterfront staple for decades overlooking Saquatucket Harbor. Known for "million dollar views" and fresh local seafood.', details: { address: '705 Rt 28, Harwich Port, MA 02646', hours: '11:30 AM - 8 PM', link: 'https://maps.app.goo.gl/E8F3G0H1I4J5K6L7M'}, lat: 41.6601, lng: -70.0706,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1517248135467-4c7edcad4725?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxMHx8d2F0ZXJmcm9udCUyMGRpbmluSyUyMHJlc3RhdXJhcmludHwzZmE0YzY3YmFzZGN0MTcwODU3MjAwMDkwfDA&ixlib=rb-4.0.3&q=80&w=400', alt: 'Elegant waterfront dining with harbor view', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/bdb76b/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1559985960-98d7950c4224?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwyfHxmcmVzaCUyMHNlYWZvb2QlMjBwbGF0ZXxlbnwwfHx8fDE3MDg2NDMzMzh8MA', alt: 'Beautifully plated seafood dish', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/bdb76b/fdfdf5?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1549596856-11f87a8b3f4f?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw2fHxyZXN0YXVyYW50JTIwZXh0ZXJpb3IlMjBoYXJib3J8ZW58MHx8fHwxNzA4NjQzMzM4fDA', alt: 'Restaurant exterior overlooking a calm harbor', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/bdb76b/fdfdf5?text=Image+Not+Found';" }
                      ]
                    },
                    { type: 'walk', title: 'Tranquil Path: Bell\'s Neck Conservation Lands', content: 'A peaceful, natural escape with a 2.75-mile loop around the reservoir offering sweeping salt marsh views and excellent birdwatching.', details: { address: 'Depot St, Harwich, MA 02645', hours: 'Public access', link: 'https://maps.app.goo.gl/F9G4H1I2J5K6L7M8N'}, lat: 41.7011, lng: -70.0905,
                      images: [
                        { src: 'https://images.unsplash.com/photo-1507914488975-fc2142d1e21b?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHw0fHxyZXNlcnZvaXIlMjBsYW5kc2NhcGV8ZW58MHx8fHwxNzA4NjQzNDM0fDA', alt: 'Scenic view of a tranquil reservoir with trees', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d8bfd8/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1629851080350-a92c3a37d6e6?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwxfHxzYWx0JTIwbWFyc2glMjBjYXBlJTIwY29kfGVufDB8fHx8MTcwODY0MzQzNHww', alt: 'Vast salt marsh landscape with a winding creek', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d8bfd8/2e3a47?text=Image+Not+Found';" },
                        { src: 'https://images.unsplash.com/photo-1549449033-038b368725ae?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=400&h=250&fit=crop&ixid=M3w1NzgyMjN8MHwxfHNlYXJjaHwzfHxuYXR1cmUlMjB3YWxrJTIwdHJhaWx8ZW58MHx8fHwxNzA4NjQzNDM0fDA', alt: 'Peaceful walking trail through natural scenery', onerror: "this.onerror=null;this.src='https://placehold.co/400x250/d8bfd8/2e3a47?text=Image+Not+Found';" }
                      ]
                    }
                ]
            }
        };

        const allMapLocations = [];
        // Add Centerville as the starting point
        const centervilleLocation = {
            name: "Centerville (Your Starting Point)",
            lat: 41.6520,
            lng: -70.3340,
            itinerary: "centerville", // Custom itinerary for coloring
            type: "start",
            description: "Your starting point on Cape Cod.",
            link: "https://maps.app.goo.gl/yourcentervillelocation" // Example link for Centerville
        };
        allMapLocations.push(centervilleLocation);

        for (const town in itineraryData) {
            itineraryData[town].timeline.forEach(item => {
                // Ensure lat/lng exist for the item
                if (item.lat && item.lng) {
                    allMapLocations.push({
                        name: item.title,
                        lat: item.lat,
                        lng: item.lng,
                        itinerary: town, // Associate with its itinerary for filtering/coloring
                        type: item.type,
                        description: item.content,
                        link: item.details.link || null // Include the Google Maps link
                    });
                }
            });
        }

        let mapInstance;
        let mapMarkers = [];
        let mapInfoWindow;
        let userLocationMapMarker;
        let watchIdMap;
        let locationEnabledMap = false;

        const selector = document.getElementById('itinerary-selector');
        const detailsContainer = document.getElementById('itinerary-details');
        const cards = selector.querySelectorAll('.itinerary-card');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const messageBox = document.getElementById('messageBox');

        function generateTimelineHTML(town) {
            const data = itineraryData[town];
            if (!data) return '';

            const icons = {
                cafe: '‚òï',
                shop: 'üõçÔ∏è',
                lunch: 'üç¥',
                walk: 'üö∂‚Äç‚ôÄÔ∏è'
            };

            let timelineHTML = data.timeline.map(item => {
                let imagesHTML = '';
                if (item.images && item.images.length > 0) {
                    imagesHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-4 mb-4 ml-9">
                        ${item.images.map(img => `
                            <img src="${img.src}" alt="${img.alt}" class="w-full h-32 object-cover rounded-md shadow-sm" onerror="${img.onerror}">
                        `).join('')}
                    </div>`;
                }

                let detailsHTML = '';
                if (item.details) {
                    if (Array.isArray(item.details)) {
                        detailsHTML = `<div class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2">
                            ${item.details.map(d => `<a href="${d.link}" target="_blank" rel="noopener noreferrer" class="text-sm text-center bg-gray-100 hover:bg-gray-200 text-gray-800 py-1 px-2 rounded-md transition-colors"><span>${d.name}</span></a>`).join('')}
                        </div>`;
                    } else {
                        detailsHTML = `<div class="mt-4 space-y-2">
                            <p class="text-sm"><strong class="font-semibold">Address:</strong> ${item.details.address}</p>
                            <p class="text-sm"><strong class="font-semibold">Hours:</strong> ${item.details.hours}</p>
                            <a href="${item.details.link}" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 bg-slate-700 hover:bg-slate-800 text-white py-2 px-4 rounded-md transition-colors text-sm">Open in Google Maps</a>
                        </div>`;
                    }
                }

                return `
                <div class="relative pl-8 pb-8 timeline-item border-l-2 border-dotted border-gray-300">
                    <div class="flex items-center mb-2">
                        <span class="text-xl mr-3">${icons[item.type] || '‚Ä¢'}</span>
                        <h4 class="font-bold text-lg">${item.title}</h4>
                    </div>
                    <p class="text-gray-600 ml-9">${item.content}</p>
                    ${imagesHTML}
                    <div class="ml-9">${detailsHTML}</div>
                </div>
                `;
            }).join('');

            // Remove the last item's bottom border-dotted to clean up the timeline end
            return `
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-inner border border-gray-200">
                <h2 class="text-3xl font-bold font-display text-center mb-4">${data.title}</h2>
                <p class="text-center text-gray-600 mb-8 max-w-2xl mx-auto">${data.description}</p>
                <div class="relative">${timelineHTML.replace(/border-l-2 border-dotted border-gray-300(?=[^]*last-of-type)/, 'border-l-2 border-gray-300')}</div>
            </div>`;
        }
        
        selector.addEventListener('click', (e) => {
            const card = e.target.closest('.itinerary-card');
            if (!card) return;

            const selectedTown = card.dataset.town;

            cards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            
            detailsContainer.style.opacity = 0;
            setTimeout(() => {
                detailsContainer.innerHTML = generateTimelineHTML(selectedTown);
                detailsContainer.style.opacity = 1;
            }, 300);
        });

        const ctx = document.getElementById('driveTimeChart').getContext('2d');
        const driveTimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Wellfleet', 'Orleans', 'Harwich Port'],
                datasets: [{
                    label: 'Estimated Drive Time (minutes)',
                    data: [48, 31, 35],
                    backgroundColor: [
                        'rgba(199, 167, 131, 0.6)',
                        'rgba(74, 85, 104, 0.6)',
                        'rgba(148, 163, 184, 0.6)'
                    ],
                    borderColor: [
                        'rgba(199, 167, 131, 1)',
                        'rgba(74, 85, 104, 1)',
                        'rgba(148, 163, 184, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Minutes'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + ' minutes';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Tab switching logic
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => btn.classList.remove('active-tab', 'bg-gray-400'));
                button.classList.add('active-tab', 'bg-gray-400');

                tabContents.forEach(content => {
                    if (content.id === `${targetTab}-tab-content`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });

                // Initialize map only when the map tab is activated
                if (targetTab === 'map' && !mapInstance) {
                    initMap();
                } else if (targetTab === 'map' && mapInstance) {
                     // If map already initialized, just ensure markers are correct
                    filterMapMarkers('All'); // Show all markers by default on map tab activation
                    if (userLocationMapMarker && locationEnabledMap) {
                        userLocationMapMarker.setMap(mapInstance);
                    }
                }
            });
        });

        // Function to display a temporary message
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        // Function to get marker color based on itinerary
        function getMapMarkerColor(itinerary) {
            switch (itinerary) {
                case "wellfleet":
                    return "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Blue for Wellfleet
                case "orleans":
                    return "http://maps.google.com/mapfiles/ms/icons/green-dot.png"; // Green for Orleans
                case "harwich":
                    return "http://maps.google.com/mapfiles/ms/icons/orange-dot.png"; // Orange for Harwich Port
                case "centerville":
                    return "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"; // Purple for Centerville
                default:
                    return "http://maps.google.com/mapfiles/ms/icons/red-dot.png"; // Default
            }
        }

        // Initialize the map
        function initMap() {
            const capeCodCenter = { lat: 41.70, lng: -70.25 }; // General center of Cape Cod for initial view
            mapInstance = new google.maps.Map(document.getElementById("map-container"), {
                center: capeCodCenter,
                zoom: 11,
                streetViewControl: false,
                mapTypeControl: false,
                fullscreenControl: false
            });

            mapInfoWindow = new google.maps.InfoWindow();

            // Add all predefined locations to the map
            addMapMarkers(allMapLocations);

            // Add event listeners for filter buttons on map tab
            document.querySelectorAll('.filter-map-button').forEach(button => {
                button.addEventListener('click', () => {
                    const itinerary = button.dataset.itinerary;
                    filterMapMarkers(itinerary);
                });
            });

            // Add event listener for the live location toggle button on map tab
            document.getElementById('toggleMapLocation').addEventListener('click', toggleLiveLocationMap);
        }

        // Function to add markers to the map
        function addMapMarkers(locs) {
            mapMarkers.forEach(marker => marker.setMap(null));
            mapMarkers = [];

            locs.forEach(location => {
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: mapInstance,
                    title: location.name,
                    icon: {
                        url: getMapMarkerColor(location.itinerary),
                        scaledSize: new google.maps.Size(30, 30)
                    },
                    itinerary: location.itinerary // Custom property for filtering
                });

                marker.addListener("click", () => {
                    mapInfoWindow.close();
                    let infoWindowContent = `
                        <div class="info-window-content">
                            <h3>${location.name}</h3>
                            <p><strong>Itinerary:</strong> ${location.itinerary.charAt(0).toUpperCase() + location.itinerary.slice(1)}</p>
                            <p>${location.description}</p>
                    `;
                    if (location.link) {
                        infoWindowContent += `<p><a href="${location.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold mt-2 inline-block">Open in Google Maps</a></p>`;
                    }
                    infoWindowContent += `</div>`;
                    mapInfoWindow.setContent(infoWindowContent);
                    mapInfoWindow.open(mapInstance, marker);
                });
                mapMarkers.push(marker);
            });
             // Ensure the user marker is re-added if it exists and location is enabled
            if (userLocationMapMarker && locationEnabledMap) {
                userLocationMapMarker.setMap(mapInstance);
            }
        }

        // Function to filter markers by itinerary
        function filterMapMarkers(selectedItinerary) {
            mapMarkers.forEach(marker => {
                if (selectedItinerary === "All" || marker.itinerary === selectedItinerary || marker.itinerary === "centerville") {
                    marker.setMap(mapInstance);
                } else {
                    marker.setMap(null);
                }
            });
            // Keep user location marker visible regardless of itinerary filter if tracking is active
            if (userLocationMapMarker && locationEnabledMap) {
                userLocationMapMarker.setMap(mapInstance);
            }
        }

        // Handle successful geolocation for map
        function handleGeolocationSuccessMap(position) {
            const pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };

            if (userLocationMapMarker) {
                userLocationMapMarker.setMap(null);
            }

            userLocationMapMarker = new google.maps.Marker({
                position: pos,
                map: mapInstance,
                title: "Your current location",
                icon: {
                    url: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 35 35'><text x='50%' y='50%' font-size='30' text-anchor='middle' dominant-baseline='central'>%F0%9F%9B%B2</text></svg>",
                    scaledSize: new google.maps.Size(35, 35)
                },
                zIndex: google.maps.Marker.MAX_ZINDEX + 1
            });

            mapInstance.setCenter(pos);
            showMessage("Your live location is being tracked.");
        }

        // Handle geolocation errors for map
        function handleGeolocationErrorMap(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "Geolocation permission denied. Please enable location services in your browser settings to use this feature.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
                default:
                    message = "An unknown error occurred while getting your location.";
                    break;
            }
            showMessage(message);
            console.error("Geolocation Error: ", message);
            disableLiveLocationMap();
        }

        // Function to enable live location tracking for map
        function enableLiveLocationMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(handleGeolocationSuccessMap, handleGeolocationErrorMap);
                watchIdMap = navigator.geolocation.watchPosition(handleGeolocationSuccessMap, handleGeolocationErrorMap, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                locationEnabledMap = true;
                document.getElementById('toggleMapLocation').textContent = 'Disable Live Location';
                document.getElementById('toggleMapLocation').classList.remove('bg-purple-600', 'hover:bg-purple-700');
                document.getElementById('toggleMapLocation').classList.add('bg-red-600', 'hover:bg-red-700');
            } else {
                showMessage("Geolocation is not supported by your browser.");
            }
        }

        // Function to disable live location tracking for map
        function disableLiveLocationMap() {
            if (watchIdMap) {
                navigator.geolocation.clearWatch(watchIdMap);
                watchIdMap = null;
            }
            if (userLocationMapMarker) {
                userLocationMapMarker.setMap(null);
                userLocationMapMarker = null;
            }
            locationEnabledMap = false;
            document.getElementById('toggleMapLocation').textContent = 'Enable Live Location';
            document.getElementById('toggleMapLocation').classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('toggleMapLocation').classList.add('bg-purple-600', 'hover:bg-purple-700');
            showMessage("Live location tracking disabled.");
        }

        // Toggle function for the map live location button
        function toggleLiveLocationMap() {
            if (locationEnabledMap) {
                disableLiveLocationMap();
            } else {
                enableLiveLocationMap();
            }
        }

        // Load the Google Maps API script
        const googleMapsApiKey = ""; // This will be automatically populated by the environment.
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initMap`;
        script.async = true;
        document.head.appendChild(script);

        // Initial load: select the first itinerary and activate the itineraries tab
        document.getElementById('wellfleet-card').click();
        document.querySelector('.tab-button[data-tab="itineraries"]').classList.add('active-tab', 'bg-gray-400');
    </script>

</body>
</html>
